networks:
  monitoring:
  
services:

  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: crm-app
    ports:
      - "9091:9091"
    networks:
      - monitoring
    depends_on:
      mysql:
        condition: service_healthy
    restart: unless-stopped
  mysql:
    image: 'mysql:latest'
    environment:
      - 'MYSQL_DATABASE=clients'
      - 'MYSQL_PASSWORD=secret'
      - 'MYSQL_ROOT_PASSWORD=verysecret'
      - 'MYSQL_USER=myuser'
    ports:
      - '3306:3306'
    networks:
      - monitoring
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      timeout: 20s
      retries: 10
    restart: unless-stopped

  prometheus:
    image: 'prom/prometheus:latest'
    container_name: 'prometheus'
    ports:
      - '9090:9090'
    volumes:
      - './prometheus:/etc/prometheus'
    networks:
      - monitoring
    depends_on:
    - app
    restart: unless-stopped

  grafana:
    image: 'grafana/grafana:latest'
    container_name: 'grafana'
    ports:
      - '3000:3000'
    environment:
      - 'GF_SECURITY_ADMIN_USER=admin'
      - 'GF_SECURITY_ADMIN_PASSWORD=admin'
    networks:
      - monitoring
    restart: unless-stopped

  rabbitmq:
    image: 'rabbitmq:3-management'
    container_name: 'my-rabbit'
    ports:
      - '5672:5672'
      - '15672:15672'
    networks:
      - monitoring
    restart: unless-stopped

  jenkins:
    image: jenkins/jenkins:lts
    container_name: jenkins
    user: root
    ports:
      - "8080:8080"
      - "50000:50000"
    volumes: 
      - ./jenkins_data:/var/jenkins_home
      - /var/run/docker.sock:/var/run/docker.sock
      - /usr/bin/docker:/usr/bin/docker
    networks:
      - monitoring
    restart: unless-stopped